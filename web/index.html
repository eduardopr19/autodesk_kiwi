<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AutoDesk Kiwi - Hub personnel de productivitÃ©">
  <title>AutoDesk Kiwi - ProductivitÃ©</title>

  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Kiwi">

  
  <link rel="stylesheet" href="style.css">
  
  
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="app()" x-init="init()">

  
  <div class="toast-container">
    <template x-for="toast in toasts" :key="toast.id">
      <div class="toast" :class="toast.type" x-show="toast.show" x-transition>
        <span class="toast-icon" x-text="toast.icon"></span>
        <span class="toast-message" x-text="toast.message"></span>
        <button class="toast-close" @click="removeToast(toast.id)">Ã—</button>
      </div>
    </template>
  </div>

  
  <header class="topbar">
    <h1 @click="currentView = 'today'" style="cursor: pointer;">ğŸ¥ AutoDesk Kiwi</h1>
    <nav class="tabs">
      <button class="tab" :class="{ active: currentView === 'today' }" @click="currentView = 'today'">
        ğŸ“… Aujourd'hui
      </button>
      <button class="tab" :class="{ active: currentView === 'tasks' }" @click="currentView = 'tasks'">
        âœ… TÃ¢ches
      </button>
      <button class="tab" :class="{ active: currentView === 'weather' }" @click="currentView = 'weather'">
        ğŸŒ¤ï¸ MÃ©tÃ©o
      </button>
      <button class="tab" :class="{ active: currentView === 'hyperplanning' }" @click="currentView = 'hyperplanning'">
        ğŸ“ Hyperplanning
      </button>
      <button class="tab" :class="{ active: currentView === 'mail' }" @click="currentView = 'mail'">
        ğŸ“¬ Mail
      </button>
      <button class="tab" :class="{ active: currentView === 'settings' }" @click="currentView = 'settings'">
        âš™ï¸ ParamÃ¨tres
      </button>
      <button class="tab theme-toggle" @click="toggleFocusMode()" :class="{ active: focusMode }" title="Mode Focus">
        ğŸ¯
      </button>
      <button class="tab theme-toggle" @click="toggleTheme()" :title="theme === 'auto' ? 'Mode: Auto (systÃ¨me)' : theme === 'dark' ? 'Mode: Sombre' : 'Mode: Clair'">
        <span x-text="getThemeIcon()"></span>
      </button>
    </nav>
  </header>

  <main>
    
    
    <section x-show="currentView === 'today'" x-transition:enter="view-enter" x-transition:leave="view-leave" class="view">
      <h2>ğŸ“… RÃ©sumÃ© du jour</h2>

      
      <div class="today-widgets">
        
        <div class="clock-widget">
          <div class="clock-time" x-text="clock.time"></div>
          <div class="clock-date" x-text="clock.date"></div>
        </div>

        
        <div class="pomodoro-widget" :class="pomodoro.mode">
          <div class="pomodoro-label" x-text="getPomodoroLabel()"></div>
          <div class="pomodoro-time" x-text="formatPomodoro()"></div>
          <div class="pomodoro-controls">
            <button x-show="!pomodoro.isRunning" @click="startPomodoro()" class="primary">â–¶ï¸ Start</button>
            <button x-show="pomodoro.isRunning" @click="pausePomodoro()" class="btn">â¸ï¸ Pause</button>
            <button @click="resetPomodoro()" class="btn">ğŸ”„</button>
            <button @click="skipPomodoro()" class="btn" title="Passer">â­ï¸</button>
          </div>
          <div class="pomodoro-count">
            ğŸ… <span x-text="pomodoro.completedPomodoros"></span> pomodoro(s)
          </div>
        </div>
      </div>

      <div class="card quote-card" x-show="overview.quote && !focusMode">
        <div class="quote-content">
          <p class="quote-text">"<span x-text="overview.quote"></span>"</p>
          <p class="quote-author" x-show="overview.quote_author">â€” <span x-text="overview.quote_author"></span></p>
        </div>
        <button class="btn-icon refresh-quote" @click="refreshQuote()" title="Nouvelle citation">ğŸ”„</button>
      </div>

      <div class="card" x-show="!focusMode && (hyperplanning.nextCourses.length || weather.current.temp || email.count !== null)">
        <p x-show="hyperplanning.nextCourses.length"><strong>ğŸ“† Prochain cours:</strong>
          <span x-text="hyperplanning.nextCourses[0]?.subject"></span> Ã 
          <span x-text="hyperplanning.nextCourses[0]?.start"></span>
          <span x-show="hyperplanning.nextCourses[0]?.room">(<span x-text="hyperplanning.nextCourses[0]?.room"></span>)</span>
        </p>
        <p x-show="weather.current.temp"><strong>ğŸŒ¡ï¸ MÃ©tÃ©o <span x-text="weather.location"></span>:</strong> 
          <span x-text="Math.round(weather.current.temp)"></span>Â°C - 
          <span x-text="getWeatherDesc(weather.current.weathercode)"></span>
        </p>
        <p x-show="email.count !== null"><strong>ğŸ“¬ Proton Mail:</strong>
          <span x-text="email.count"></span> non lu(s)
          <span x-show="email.error" style="color: var(--danger);">(<span x-text="email.error"></span>)</span>
        </p>
      </div>

      
      <div x-show="!focusMode">
      <h3>ğŸ“ Notes rapides</h3>
      <div class="card quick-notes-card">
        <textarea
          class="quick-notes-textarea"
          x-model="quickNotes"
          @input="saveQuickNotes()"
          placeholder="Ã‰crivez vos notes ici..."
        ></textarea>
      </div>
      </div>

      <div x-show="!focusMode">
      <h3>ğŸ”— Liens favoris <button class="btn-icon" @click="showAddLink = !showAddLink" title="Ajouter un lien">â•</button></h3>
      <div class="card favorite-links-card">
        
        <div class="add-link-form" x-show="showAddLink" x-transition>
          <input type="text" x-model="newLink.name" placeholder="Nom du lien" class="input-field">
          <input type="url" x-model="newLink.url" placeholder="https://..." class="input-field" @keyup.enter="addFavoriteLink()">
          <button class="btn btn-primary" @click="addFavoriteLink()">Ajouter</button>
        </div>
        
        <div class="links-list" x-show="favoriteLinks.length">
          <template x-for="link in favoriteLinks" :key="link.id">
            <div class="link-item">
              <a :href="link.url" target="_blank" rel="noopener" x-text="link.name"></a>
              <button class="btn-icon remove-link" @click="removeFavoriteLink(link.id)" title="Supprimer">âœ•</button>
            </div>
          </template>
        </div>
        <p x-show="!favoriteLinks.length && !showAddLink" class="empty-links">Aucun lien favori. Cliquez sur â• pour en ajouter.</p>
      </div>
      </div>

      <div x-show="!focusMode">
      <h3>â³ Compte Ã  rebours <button class="btn-icon" @click="showAddCountdown = !showAddCountdown" title="Ajouter un Ã©vÃ©nement">â•</button></h3>
      <div class="card countdowns-card">
        
        <div class="add-countdown-form" x-show="showAddCountdown" x-transition>
          <input type="text" x-model="newCountdown.name" placeholder="Nom de l'Ã©vÃ©nement" class="input-field">
          <input type="date" x-model="newCountdown.date" class="input-field">
          <button class="btn btn-primary" @click="addCountdown()">Ajouter</button>
        </div>
        
        <div class="countdowns-list" x-show="countdowns.length">
          <template x-for="countdown in countdowns" :key="countdown.id">
            <div class="countdown-item" :class="{ 'passed': getDaysRemaining(countdown.date) < 0 }">
              <div class="countdown-info">
                <span class="countdown-name" x-text="countdown.name"></span>
                <span class="countdown-date" x-text="formatCountdownDate(countdown.date)"></span>
              </div>
              <div class="countdown-days">
                <span class="days-number" x-text="Math.abs(getDaysRemaining(countdown.date))"></span>
                <span class="days-label" x-text="getDaysRemaining(countdown.date) >= 0 ? 'jours restants' : 'jours passÃ©s'"></span>
              </div>
              <button class="btn-icon remove-countdown" @click="removeCountdown(countdown.id)" title="Supprimer">âœ•</button>
            </div>
          </template>
        </div>
        <p x-show="!countdowns.length && !showAddCountdown" class="empty-countdowns">Aucun compte Ã  rebours. Cliquez sur â• pour en ajouter.</p>
      </div>
      </div>

      <div class="card lofi-card">
        <div class="lofi-header" @click="toggleLofiPlayer()">
          <h4 style="margin: 0;">ğŸµ Lofi Hip Hop Radio</h4>
          <span class="lofi-toggle" x-text="lofiPlayer.show ? 'â–¼' : 'â–¶'"></span>
        </div>
        <div class="lofi-player" x-show="lofiPlayer.show" x-transition>
          <iframe
            width="100%"
            height="200"
            src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=0"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen>
          </iframe>
          <p class="lofi-credit">Lofi Girl - beats to relax/study to</p>
        </div>
      </div>

      <div x-show="!focusMode">
      <h3>ğŸ“Š Statistiques des tÃ¢ches</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" x-text="stats.total || 0"></div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="stats.by_status?.todo || 0"></div>
          <div class="stat-label">Ã€ faire</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="stats.by_status?.doing || 0"></div>
          <div class="stat-label">En cours</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="stats.by_status?.done || 0"></div>
          <div class="stat-label">TerminÃ©es</div>
        </div>
      </div>
      </div>

      <!-- Gamification Section -->
      <div x-show="!focusMode">
      <h3>ğŸ® Progression</h3>
      <div class="card gamification-card">
        <div class="gamification-header">
          <div class="level-info">
            <span class="level-icon" x-text="getCurrentLevel().icon"></span>
            <div class="level-details">
              <span class="level-name">Niveau <span x-text="getCurrentLevel().level"></span> - <span x-text="getCurrentLevel().name"></span></span>
              <div class="xp-bar">
                <div class="xp-fill" :style="`width: ${getLevelProgress()}%`"></div>
              </div>
              <span class="xp-text"><span x-text="gamification.xp"></span> XP</span>
            </div>
          </div>
          <div class="streak-info">
            <span class="streak-fire">ğŸ”¥</span>
            <span class="streak-count" x-text="gamification.streak"></span>
            <span class="streak-label">jours</span>
          </div>
        </div>

        <div class="gamification-stats">
          <div class="gam-stat">
            <span class="gam-stat-value" x-text="gamification.totalTasksCompleted"></span>
            <span class="gam-stat-label">TÃ¢ches</span>
          </div>
          <div class="gam-stat">
            <span class="gam-stat-value" x-text="gamification.totalPomodorosCompleted"></span>
            <span class="gam-stat-label">Pomodoros</span>
          </div>
          <div class="gam-stat">
            <span class="gam-stat-value" x-text="gamification.unlockedBadges.length"></span>
            <span class="gam-stat-label">Badges</span>
          </div>
        </div>

        <div class="badges-section">
          <h4>ğŸ… Badges</h4>
          <div class="badges-grid">
            <template x-for="badge in badges" :key="badge.id">
              <div class="badge-item" :class="{ 'unlocked': isBadgeUnlocked(badge.id) }" :title="badge.desc">
                <span class="badge-icon" x-text="badge.icon"></span>
                <span class="badge-name" x-text="badge.name"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
      </div>

      <!-- Habit Tracker Section -->
      <div x-show="!focusMode">
      <h3>ğŸ“‹ Habitudes <button class="btn-icon" @click="showAddHabit = !showAddHabit" title="Ajouter une habitude">â•</button></h3>
      <div class="card habit-tracker-card">
        <!-- Add habit form -->
        <div class="add-habit-form" x-show="showAddHabit" x-transition>
          <input type="text" x-model="newHabit.name" placeholder="Nom de l'habitude" class="input-field" @keyup.enter="addHabit()">
          <select x-model="newHabit.icon" class="icon-select">
            <option value="âœ…">âœ…</option>
            <option value="ğŸ’ª">ğŸ’ª</option>
            <option value="ğŸ“–">ğŸ“–</option>
            <option value="ğŸ’§">ğŸ’§</option>
            <option value="ğŸ§˜">ğŸ§˜</option>
            <option value="ğŸƒ">ğŸƒ</option>
            <option value="ğŸ">ğŸ</option>
            <option value="ğŸ’¤">ğŸ’¤</option>
            <option value="âœï¸">âœï¸</option>
            <option value="ğŸ¯">ğŸ¯</option>
          </select>
          <button class="btn primary" @click="addHabit()">Ajouter</button>
        </div>

        <!-- Habit list with calendar grid -->
        <div class="habits-list" x-show="habits.length">
          <!-- Header with days -->
          <div class="habit-row habit-header">
            <div class="habit-name-col"></div>
            <template x-for="day in getLast7Days()" :key="day.date">
              <div class="habit-day-col" :class="{ 'today': day.isToday }">
                <span class="day-name" x-text="day.dayName"></span>
                <span class="day-num" x-text="day.dayNum"></span>
              </div>
            </template>
            <div class="habit-streak-col">Streak</div>
          </div>

          <!-- Habit rows -->
          <template x-for="habit in habits" :key="habit.id">
            <div class="habit-row">
              <div class="habit-name-col">
                <span class="habit-icon" x-text="habit.icon"></span>
                <span class="habit-name" x-text="habit.name"></span>
                <button class="btn-icon habit-delete" @click="removeHabit(habit.id)" title="Supprimer">âœ•</button>
              </div>
              <template x-for="day in getLast7Days()" :key="day.date">
                <div class="habit-day-col">
                  <button
                    class="habit-check"
                    :class="{ 'done': isHabitDone(habit.id, day.date) }"
                    @click="toggleHabitDay(habit.id, day.date)"
                  >
                    <span x-show="isHabitDone(habit.id, day.date)">âœ“</span>
                  </button>
                </div>
              </template>
              <div class="habit-streak-col">
                <span class="habit-streak" x-text="getHabitStreak(habit.id)"></span>ğŸ”¥
              </div>
            </div>
          </template>
        </div>

        <p x-show="!habits.length && !showAddHabit" class="empty-habits">
          Aucune habitude. Cliquez sur â• pour en ajouter.
        </p>
      </div>
      </div>

      <div x-show="!focusMode">
      <h3>ğŸµ Spotify</h3>
      <div class="card spotify-card">
        
        <div x-show="!spotify.connected && !spotify.error.includes('not configured')">
          <p style="margin-bottom: 15px;">Connectez-vous Ã  Spotify pour voir votre musique en cours.</p>
          <button @click="spotifyLogin()" class="primary">ğŸ”— Se connecter Ã  Spotify</button>
        </div>

        
        <div x-show="spotify.error.includes('not configured')" class="empty">
          <p>Spotify non configurÃ©. Ajoutez vos identifiants API dans le fichier <code>.env</code>.</p>
        </div>

        
        <div x-show="spotify.connected">
          
          <div x-show="spotify.track" class="spotify-player">
            <img
              x-show="spotify.track?.album_art"
              :src="spotify.track?.album_art"
              alt="Album Art"
              class="spotify-album-art"
            />
            <div class="spotify-info">
              <div class="spotify-track" x-text="spotify.track?.track_name"></div>
              <div class="spotify-artist" x-text="spotify.track?.artist_name"></div>
              <div class="spotify-album" x-text="spotify.track?.album_name"></div>
              <div class="spotify-progress">
                <span x-text="formatTime(spotify.track?.progress_ms)"></span>
                <span class="text-muted"> / </span>
                <span x-text="formatTime(spotify.track?.duration_ms)"></span>
              </div>
            </div>
          </div>

          
          <div x-show="!spotify.track" class="empty" style="margin-bottom: 15px;">
            Aucune musique en cours de lecture.
          </div>

          
          <div class="spotify-controls">
            <button @click="spotifyPrevious()" class="btn spotify-btn" title="PrÃ©cÃ©dent">â®ï¸</button>
            <button x-show="!spotify.track?.is_playing" @click="spotifyPlay()" class="primary spotify-btn" title="Lecture">â–¶ï¸</button>
            <button x-show="spotify.track?.is_playing" @click="spotifyPause()" class="primary spotify-btn" title="Pause">â¸ï¸</button>
            <button @click="spotifyNext()" class="btn spotify-btn" title="Suivant">â­ï¸</button>
            <button @click="spotifyLogout()" class="btn spotify-btn-small" title="DÃ©connexion" style="margin-left: auto;">ğŸšª</button>
          </div>
        </div>
      </div>
      </div>
    </section>


    <section x-show="currentView === 'tasks'" x-transition:enter="view-enter" x-transition:leave="view-leave" class="view">
      <h2>âœ… Gestion des tÃ¢ches</h2>

      
      <form @submit.prevent="addTask()" class="toolbar task-form">
        <input
          x-model="newTask.title"
          type="text"
          placeholder="Nouvelle tÃ¢cheâ€¦"
          required
          maxlength="200"
          class="grow"
        />
        <select x-model="newTask.priority">
          <option value="low">Low</option>
          <option value="normal" selected>Normal</option>
          <option value="high">High</option>
        </select>
        <input
          x-model="newTask.due_date"
          type="datetime-local"
          title="Date d'Ã©chÃ©ance"
          style="width: 180px;"
        />
        <input
          x-model="newTask.tags"
          type="text"
          placeholder="Tags (ex: urgent, projet)"
          style="width: 150px;"
          title="Tags sÃ©parÃ©s par des virgules"
        />
        <select x-model="newTask.recurrence" title="RÃ©currence">
          <option value="">Pas de rÃ©currence</option>
          <option value="daily">ğŸ”„ Quotidien</option>
          <option value="weekly">ğŸ”„ Hebdomadaire</option>
          <option value="monthly">ğŸ”„ Mensuel</option>
        </select>
        <button type="submit" class="primary">â• Ajouter</button>
      </form>

      
      <div class="toolbar">
        <input 
          x-model="filters.q" 
          @input="debouncedLoadTasks()"
          type="search" 
          placeholder="ğŸ” Rechercherâ€¦"
          class="grow"
        />
        <select x-model="filters.status" @change="loadTasks()">
          <option value="">Tous statuts</option>
          <option value="todo">Ã€ faire</option>
          <option value="doing">En cours</option>
          <option value="done">TerminÃ©es</option>
          <option value="archived">ArchivÃ©es</option>
        </select>
        <select x-model="filters.priority" @change="loadTasks()">
          <option value="">Toutes prioritÃ©s</option>
          <option value="low">Low</option>
          <option value="normal">Normal</option>
          <option value="high">High</option>
        </select>
        <select x-model="filters.tag" @change="loadTasks()" x-show="availableTags.length">
          <option value="">Tous tags</option>
          <template x-for="tag in availableTags" :key="tag">
            <option :value="tag" x-text="tag"></option>
          </template>
        </select>
        <select x-model="filters.sort" @change="loadTasks()">
          <option value="-created_at">Plus rÃ©centes</option>
          <option value="created_at">Plus anciennes</option>
          <option value="-priority">PrioritÃ© â†“</option>
          <option value="priority">PrioritÃ© â†‘</option>
          <option value="title">Titre A-Z</option>
          <option value="-title">Titre Z-A</option>
        </select>
        <button 
          @click="bulkDelete()" 
          class="danger"
          :disabled="selectedTasks.length === 0"
        >
          ğŸ—‘ï¸ Supprimer (<span x-text="selectedTasks.length"></span>)
        </button>
        <button @click="toggleTaskViewMode()" class="btn" title="Changer de vue">
          <span x-show="taskViewMode === 'list'">ğŸ“‹ Kanban</span>
          <span x-show="taskViewMode === 'kanban'">ğŸ“ Liste</span>
        </button>
      </div>

      
      <ul class="list" x-show="!loading.tasks && taskViewMode === 'list'">
        <template x-if="tasks.length === 0">
          <li class="empty">Aucune tÃ¢che trouvÃ©e.</li>
        </template>
        
        <template x-for="task in tasks" :key="task.id">
          <li class="task-item-wrapper">
            <div class="task-item">
              <input
                type="checkbox"
                class="task-select"
                :value="task.id"
                @change="toggleTaskSelection(task.id)"
                :checked="selectedTasks.includes(task.id)"
              />
              <div class="task-main">
                <span class="task-title" x-text="task.title"></span>
                <div class="task-meta">
                  <span class="status-badge badge" :class="task.status" x-text="mapStatus(task.status)"></span>
                  <span class="badge" :class="task.priority" x-text="task.priority"></span>
                  <span x-show="task.due_date" class="due-date" :class="{ 'overdue': isOverdue(task), 'due-soon': isDueSoon(task) }">
                    ğŸ“… <span x-text="formatDueDate(task.due_date)"></span>
                  </span>
                  <template x-for="tag in getTaskTags(task)" :key="tag">
                    <span class="tag-badge" x-text="tag"></span>
                  </template>
                  <span x-show="task.recurrence" class="recurrence-badge" :title="getRecurrenceLabel(task.recurrence)">
                    ğŸ”„ <span x-text="getRecurrenceLabel(task.recurrence)"></span>
                  </span>
                  <span x-show="task.subtasks?.length" class="subtask-count">
                    ğŸ“‹ <span x-text="task.subtasks?.filter(s => s.status === 'done').length"></span>/<span x-text="task.subtasks?.length"></span>
                  </span>
                </div>
              </div>
              <div class="task-actions">
                <button @click="openAddSubtask(task)" class="btn" style="padding: 6px 10px;" title="Ajouter sous-tÃ¢che">
                  â•
                </button>
                <button @click="openEditTask(task)" class="btn" style="padding: 6px 10px;">
                  âœï¸
                </button>
                <button @click="deleteTask(task.id)" class="danger" style="padding: 6px 10px;">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
            <ul class="subtasks-list" x-show="task.subtasks?.length || addingSubtaskTo === task.id">
              <template x-for="subtask in task.subtasks" :key="subtask.id">
                <li class="subtask-item" :class="{ 'done': subtask.status === 'done' }">
                  <input
                    type="checkbox"
                    :checked="subtask.status === 'done'"
                    @change="toggleSubtaskStatus(subtask)"
                  />
                  <span class="subtask-title" x-text="subtask.title"></span>
                  <button @click="deleteTask(subtask.id)" class="btn-icon subtask-delete" title="Supprimer">âœ•</button>
                </li>
              </template>
              <li class="subtask-add-form" x-show="addingSubtaskTo === task.id">
                <input
                  type="text"
                  x-model="newSubtaskTitle"
                  @keyup.enter="addSubtask(task.id)"
                  @keyup.escape="closeAddSubtask()"
                  placeholder="Nouvelle sous-tÃ¢che..."
                  class="subtask-input"
                  x-ref="subtaskInput"
                />
                <button @click="addSubtask(task.id)" class="btn btn-sm">âœ“</button>
                <button @click="closeAddSubtask()" class="btn btn-sm">âœ•</button>
              </li>
            </ul>
          </li>
        </template>
      </ul>

      
      <div class="kanban-board" x-show="!loading.tasks && taskViewMode === 'kanban'">
        
        <div class="kanban-column"
             @dragover="onDragOver($event)"
             @dragenter="onDragEnter($event)"
             @dragleave="onDragLeave($event)"
             @drop="onDrop($event, 'todo')">
          <div class="kanban-header todo">
            <span>ğŸ“‹ Ã€ faire</span>
            <span class="kanban-count" x-text="getTasksByStatus('todo').length"></span>
          </div>
          <div class="kanban-items">
            <template x-for="task in getTasksByStatus('todo')" :key="task.id">
              <div class="kanban-card"
                   draggable="true"
                   @dragstart="onDragStart($event, task)"
                   @dragend="onDragEnd($event)">
                <div class="kanban-card-title" x-text="task.title"></div>
                <div class="kanban-card-meta">
                  <span class="badge" :class="task.priority" x-text="task.priority"></span>
                  <span x-show="task.recurrence" class="recurrence-badge-small" title="RÃ©current">ğŸ”„</span>
                  <span x-show="task.due_date" class="due-date" :class="{ 'overdue': isOverdue(task) }">
                    ğŸ“… <span x-text="formatDueDate(task.due_date)"></span>
                  </span>
                  <template x-for="tag in getTaskTags(task)" :key="tag">
                    <span class="tag-badge" x-text="tag"></span>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </div>


        <div class="kanban-column"
             @dragover="onDragOver($event)"
             @dragenter="onDragEnter($event)"
             @dragleave="onDragLeave($event)"
             @drop="onDrop($event, 'doing')">
          <div class="kanban-header doing">
            <span>ğŸ”„ En cours</span>
            <span class="kanban-count" x-text="getTasksByStatus('doing').length"></span>
          </div>
          <div class="kanban-items">
            <template x-for="task in getTasksByStatus('doing')" :key="task.id">
              <div class="kanban-card"
                   draggable="true"
                   @dragstart="onDragStart($event, task)"
                   @dragend="onDragEnd($event)">
                <div class="kanban-card-title" x-text="task.title"></div>
                <div class="kanban-card-meta">
                  <span class="badge" :class="task.priority" x-text="task.priority"></span>
                  <span x-show="task.recurrence" class="recurrence-badge-small" title="RÃ©current">ğŸ”„</span>
                  <span x-show="task.due_date" class="due-date" :class="{ 'overdue': isOverdue(task) }">
                    ğŸ“… <span x-text="formatDueDate(task.due_date)"></span>
                  </span>
                  <template x-for="tag in getTaskTags(task)" :key="tag">
                    <span class="tag-badge" x-text="tag"></span>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </div>


        <div class="kanban-column"
             @dragover="onDragOver($event)"
             @dragenter="onDragEnter($event)"
             @dragleave="onDragLeave($event)"
             @drop="onDrop($event, 'done')">
          <div class="kanban-header done">
            <span>âœ… TerminÃ©es</span>
            <span class="kanban-count" x-text="getTasksByStatus('done').length"></span>
          </div>
          <div class="kanban-items">
            <template x-for="task in getTasksByStatus('done')" :key="task.id">
              <div class="kanban-card"
                   draggable="true"
                   @dragstart="onDragStart($event, task)"
                   @dragend="onDragEnd($event)">
                <div class="kanban-card-title" x-text="task.title"></div>
                <div class="kanban-card-meta">
                  <span class="badge" :class="task.priority" x-text="task.priority"></span>
                  <span x-show="task.recurrence" class="recurrence-badge-small" title="RÃ©current">ğŸ”„</span>
                  <template x-for="tag in getTaskTags(task)" :key="tag">
                    <span class="tag-badge" x-text="tag"></span>
                  </template>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <div x-show="loading.tasks" class="empty">
        <div class="spinner"></div> Chargement...
      </div>

      
      <div x-show="editingTask" class="modal-overlay" @click.self="closeEditTask()">
        <div class="modal">
          <div class="modal-header">
            <h3>Modifier la tÃ¢che</h3>
            <button @click="closeEditTask()" class="btn" style="padding: 5px 10px;">âœ•</button>
          </div>
          <form @submit.prevent="saveEditTask()" class="modal-body">
            <div class="form-group">
              <label>Titre</label>
              <input type="text" x-model="editingTask.title" required maxlength="200" />
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea x-model="editingTask.description" rows="3" maxlength="2000"></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>PrioritÃ©</label>
                <select x-model="editingTask.priority">
                  <option value="low">Low</option>
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                </select>
              </div>
              <div class="form-group">
                <label>Statut</label>
                <select x-model="editingTask.status">
                  <option value="todo">Ã€ faire</option>
                  <option value="doing">En cours</option>
                  <option value="done">TerminÃ©e</option>
                  <option value="archived">ArchivÃ©e</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Date d'Ã©chÃ©ance</label>
              <input type="datetime-local" x-model="editingTask.due_date" />
            </div>
            <div class="form-group">
              <label>Tags (sÃ©parÃ©s par des virgules)</label>
              <input type="text" x-model="editingTask.tags" placeholder="ex: urgent, projet, perso" />
            </div>
            <div class="form-group">
              <label>RÃ©currence</label>
              <select x-model="editingTask.recurrence">
                <option value="">Pas de rÃ©currence</option>
                <option value="daily">ğŸ”„ Quotidien</option>
                <option value="weekly">ğŸ”„ Hebdomadaire</option>
                <option value="monthly">ğŸ”„ Mensuel</option>
              </select>
            </div>
            <div class="modal-actions">
              <button type="button" @click="closeEditTask()" class="btn">Annuler</button>
              <button type="submit" class="primary">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>
    </section>

    
    <section x-show="currentView === 'weather'" x-transition:enter="view-enter" x-transition:leave="view-leave" class="view">
      <h2>ğŸŒ¤ï¸ MÃ©tÃ©o <span x-text="weather.location" style="color: var(--muted);"></span></h2>
      
      <div class="card" x-show="weather.current.temp">
        <p style="font-size: 1.8rem; margin: 0;">
          <strong x-text="Math.round(weather.current.temp)"></strong>Â°C
        </p>
        <p x-text="getWeatherDesc(weather.current.weathercode)" style="margin: 5px 0;"></p>
        <p style="color: var(--muted); font-size: 0.9rem;">
          Vent: <span x-text="Math.round(weather.current.windspeed)"></span> km/h
        </p>
      </div>

      <div x-show="loading.weather" class="card">
        <div class="spinner"></div> Chargement de la mÃ©tÃ©o...
      </div>

      <h3>Prochaines heure</h3>
      <div class="chips">
        <template x-for="h in weather.hourly.slice(0, 12)" :key="h.time">
          <span class="pill" x-text="`${new Date(h.time).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})} â€¢ ${Math.round(h.temp)}Â°C â€¢ ${getWeatherDesc(h.code)} â€¢ ${h.pop || 0}%`"></span>
        </template>
      </div>

      <h3>Prochains jours</h3>
      <div class="chips">
        <template x-for="d in weather.daily" :key="d.date">
          <span class="pill" x-text="`${new Date(d.date).toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric'})} â€¢ ${Math.round(d.tmin)}Â°Câ€“${Math.round(d.tmax)}Â°C â€¢ ${getWeatherDesc(d.code)} â€¢ ${d.pop || 0}%`"></span>
        </template>
      </div>
    </section>

    
    <section x-show="currentView === 'hyperplanning'" x-transition:enter="view-enter" x-transition:leave="view-leave" class="view">
      <h2>ğŸ“ Hyperplanning</h2>
      
      <div class="hp-grid">
        
        <div class="hp-column">
          <h3 x-text="'ğŸ“… Emploi du temps (' + (hyperplanning.schedule.display_date || 'Aujourd\'hui') + ')'"></h3>
          <div class="card" x-show="hyperplanning.schedule.courses.length === 0">
            <p class="empty">Aucun cours prÃ©vu pour cette date ğŸ‰</p>
          </div>
          <div class="timeline">
            <template x-for="course in hyperplanning.schedule.courses" :key="course.id">
              <div class="timeline-item">
                <div class="timeline-time">
                  <span x-text="course.start"></span>
                  <span class="text-muted" x-text="course.end"></span>
                </div>
                <div class="timeline-content" :class="{'active': isCurrentCourse(course)}">
                  <div class="timeline-marker"></div>
                  <h4 x-text="course.subject"></h4>
                  <p class="location">ğŸ“ <span x-text="course.room"></span></p>
                  <p class="teacher">ğŸ‘¨â€ğŸ« <span x-text="course.teacher"></span></p>
                  <span class="badge" :class="course.type === 'TP' ? 'high' : 'normal'" x-text="course.type"></span>
                </div>
              </div>
            </template>
          </div>

          
          <div class="card" style="margin-top: 20px;">
            <h3>â© Prochains cours</h3>
            <ul class="list">
              <template x-for="course in hyperplanning.nextCourses" :key="course.id">
                <li class="grade-item"> 
                  <div class="grade-info">
                    <strong x-text="course.subject"></strong>
                    <div style="font-size: 0.85rem; color: var(--muted);">
                      <span x-text="new Date(course.raw_start).toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric', month: 'short'})"></span>
                      â€¢ 
                      <span x-text="course.start + (course.end ? ' - ' + course.end : '')"></span>
                    </div>
                  </div>
                  <div class="grade-value" style="font-size: 0.9rem; color: var(--text);">
                    <span x-text="course.room"></span>
                  </div>
                </li>
              </template>
            </ul>
            <div x-show="hyperplanning.nextCourses.length === 0" class="empty">
              Aucun cours Ã  venir.
            </div>
          </div>
        </div>

        
        <div class="hp-column">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">ğŸ“ DerniÃ¨res notes</h3>
            <button @click="hyperplanning.showImport = !hyperplanning.showImport" class="btn" style="font-size: 0.85rem; padding: 5px 10px;">
              <span x-show="!hyperplanning.showImport">â• Importer</span>
              <span x-show="hyperplanning.showImport">âœ–ï¸ Fermer</span>
            </button>
          </div>

          
          <div x-show="hyperplanning.showImport" class="card" style="margin-bottom: 15px; background: var(--panel-hover);">
            <h4 style="margin-top: 0; font-size: 0.9rem;">Importer des notes (JSON)</h4>
            <p style="font-size: 0.8rem; color: var(--muted); margin-bottom: 10px;">
              Format: <code style="background: var(--bg); padding: 2px 5px; border-radius: 3px;">[{"subject": "MatiÃ¨re", "date": "13 dÃ©c.", "value": 15.5}]</code>
            </p>
            <textarea
              x-model="hyperplanning.importInput"
              rows="6"
              placeholder='[
  {"subject": "Admin rÃ©seau", "date": "13 dÃ©c.", "value": 18.39},
  {"subject": "Anglais", "date": "9 dÃ©c.", "value": 14.50}
]'
              style="width: 100%; padding: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--muted); border-radius: 5px; font-family: monospace; font-size: 0.85rem; resize: vertical;"
            ></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <button @click="importGrades()" class="primary" style="flex: 1;">âœ… Importer</button>
              <button @click="clearGrades()" class="danger">ğŸ—‘ï¸ Tout supprimer</button>
            </div>
          </div>

          <div class="card">
            <ul class="list">
              <template x-for="grade in hyperplanning.grades" :key="grade.id">
                <li class="grade-item">
                  <div class="grade-info">
                    <strong x-text="grade.subject"></strong>
                    <small x-text="grade.date"></small>
                  </div>
                  <div class="grade-value" :class="getGradeColor(grade.value)">
                    <span x-text="grade.value"></span><span class="grade-max">/20</span>
                  </div>
                </li>
              </template>
            </ul>
            <div x-show="hyperplanning.grades.length === 0" class="empty">
              Aucune note. Cliquez sur "Importer" pour ajouter vos notes.
            </div>
          </div>

          <h3 style="margin-top: 20px;">ğŸ“š Enseignements par matiÃ¨re</h3>
          <div class="card">
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;">
              <template x-for="stat in hyperplanning.stats" :key="stat.subject">
                <div class="stat-card" style="text-align: center; padding: 10px;">
                  <div class="stat-value" style="font-size: 1.2rem;" x-text="stat.done + 'h'"></div>
                  <div class="stat-label" style="font-size: 0.8rem; margin-bottom: 5px;" x-text="stat.subject"></div>
                  <div style="font-size: 0.7rem; color: var(--muted);">
                    PrÃ©vu: <span x-text="stat.planned"></span>h
                  </div>
                </div>
              </template>
            </div>
            <div x-show="hyperplanning.stats.length === 0" class="empty">
              Chargement des statistiques...
            </div>
          </div>

          <h3 style="margin-top: 20px;">ğŸ”— AccÃ¨s rapide</h3>
          <div class="card">
            <a href="https://extranet-hp-cgy.ensup.eu/hp-cgy/etudiant" target="_blank" class="hp-link">
              ğŸŒ Ouvrir Hyperplanning (Extranet) â†—
            </a>
          </div>
        </div>
      </div>
    </section>

    
    <section x-show="currentView === 'mail'" x-transition:enter="view-enter" x-transition:leave="view-leave" class="view">
      <h2>ğŸ“¬ Proton Mail</h2>

      
      <div class="card" style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <span style="font-size: 2rem; font-weight: bold;" x-text="email.count ?? '?'"></span>
            <span style="color: var(--muted);"> email(s) non lu(s)</span>
          </div>
          <div style="display: flex; gap: 10px;">
            <button @click="email.showCompose = !email.showCompose" class="primary" style="padding: 8px 15px;">
              <span x-show="!email.showCompose">âœ‰ï¸ Nouveau</span>
              <span x-show="email.showCompose">âœ–ï¸ Fermer</span>
            </button>
            <button @click="loadEmail()" class="btn" style="padding: 8px 15px;">
              ğŸ”„ RafraÃ®chir
            </button>
          </div>
        </div>
        <div x-show="email.error" style="margin-top: 10px; padding: 10px; background: var(--danger); border-radius: 5px;">
          âš ï¸ <span x-text="email.error"></span>
        </div>
      </div>

      
      <div x-show="email.showCompose" class="card" style="margin-bottom: 20px; background: var(--panel-hover);">
        <h3 style="margin-top: 0;">âœ‰ï¸ Nouveau message</h3>
        <form @submit.prevent="sendEmail()" style="display: flex; flex-direction: column; gap: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Ã€ :</label>
            <input
              type="email"
              x-model="email.compose.to"
              placeholder="destinataire@exemple.com"
              required
              style="width: 100%; padding: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--muted); border-radius: 5px;"
            />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Sujet :</label>
            <input
              type="text"
              x-model="email.compose.subject"
              placeholder="Sujet du message"
              required
              style="width: 100%; padding: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--muted); border-radius: 5px;"
            />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Message :</label>
            <textarea
              x-model="email.compose.body"
              rows="8"
              placeholder="Votre message..."
              style="width: 100%; padding: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--muted); border-radius: 5px; resize: vertical;"
            ></textarea>
          </div>
          <div style="display: flex; gap: 10px;">
            <button type="submit" class="primary" style="flex: 1;" :disabled="email.sending">
              <span x-show="!email.sending">ğŸ“¤ Envoyer</span>
              <span x-show="email.sending">â³ Envoi en cours...</span>
            </button>
            <button type="button" @click="email.compose = { to: '', subject: '', body: '' }" class="btn">
              ğŸ—‘ï¸ Effacer
            </button>
          </div>
        </form>
      </div>

      
      <h3>ğŸ“¥ Derniers emails non lus</h3>
      <div class="card">
        <ul class="list">
          <template x-for="mail in email.emails" :key="mail.id">
            <li class="email-item" @click="openEmail(mail)">
              <strong x-text="mail.subject"></strong>
              <div class="email-meta">
                <span x-text="mail.sender"></span>
                <small x-text="mail.date"></small>
              </div>
            </li>
          </template>
        </ul>
        <div x-show="email.emails.length === 0 && !email.error" class="empty">
          Aucun email non lu ğŸ‰
        </div>
        <div x-show="email.error && email.emails.length === 0" class="empty">
          Impossible de charger les emails. VÃ©rifiez que Proton Bridge est lancÃ©.
        </div>
      </div>

      <div x-show="email.selectedEmail" class="modal-backdrop" @click.self="closeEmail()">
        <div class="modal email-modal">
          <div class="modal-header">
            <h3 x-text="email.selectedEmail?.subject || 'Chargement...'"></h3>
            <button @click="closeEmail()" class="modal-close">&times;</button>
          </div>
          <div class="email-info">
            <div><strong>De:</strong> <span x-text="email.selectedEmail?.sender"></span></div>
            <div><strong>Date:</strong> <span x-text="email.selectedEmail?.date"></span></div>
          </div>
          <div class="email-body">
            <div x-show="email.loadingEmail" class="loading-spinner">Chargement...</div>
            <template x-if="!email.loadingEmail && email.selectedEmail?.html_body">
              <iframe :srcdoc="email.selectedEmail?.html_body" class="email-iframe"></iframe>
            </template>
            <template x-if="!email.loadingEmail && !email.selectedEmail?.html_body">
              <pre class="email-text" x-text="email.selectedEmail?.body || 'Aucun contenu'"></pre>
            </template>
          </div>
        </div>
      </div>

      
      <h3 style="margin-top: 20px;">ğŸ”— AccÃ¨s rapide</h3>
      <div class="card">
        <a href="https://mail.proton.me" target="_blank" class="hp-link">
          ğŸŒ Ouvrir Proton Mail (Web) â†—
        </a>
      </div>

      
      <div class="card" style="margin-top: 20px; background: var(--panel-hover);">
        <h4 style="margin-top: 0;">â„¹ï¸ Configuration requise</h4>
        <p style="font-size: 0.9rem; color: var(--muted);">
          Pour afficher vos emails, vous devez avoir <strong>Proton Bridge</strong> installÃ© et lancÃ© sur votre PC.
          Les identifiants sont configurÃ©s dans le fichier <code>.env</code>.
        </p>
      </div>
    </section>

    
    <section x-show="currentView === 'settings'" x-transition:enter="view-enter" x-transition:leave="view-leave" class="view">
      <h2>âš™ï¸ ParamÃ¨tres</h2>

      
      <div class="card">
        <h3>ğŸ’¾ Sauvegarde des donnÃ©es</h3>
        <p style="color: var(--muted); margin-bottom: 16px;">
          Exportez vos donnÃ©es pour crÃ©er une sauvegarde ou les transfÃ©rer vers un autre appareil.
        </p>
        <div class="export-import-buttons">
          <button class="btn btn-primary" @click="exportData()" :disabled="importExport.exporting">
            <span x-show="!importExport.exporting">ğŸ“¤ Exporter</span>
            <span x-show="importExport.exporting">â³ Export...</span>
          </button>
          <label class="btn btn-secondary import-label">
            <span x-show="!importExport.importing">ğŸ“¥ Importer</span>
            <span x-show="importExport.importing">â³ Import...</span>
            <input type="file" accept=".json" @change="importData($event)" style="display: none;" :disabled="importExport.importing">
          </label>
        </div>
        <p style="color: var(--muted); font-size: 0.85rem; margin-top: 12px;">
          âš ï¸ L'import ajoutera les tÃ¢ches du fichier (les doublons possibles ne seront pas dÃ©tectÃ©s).
        </p>
      </div>

      <div class="card">
        <h3>â„¹ï¸ Informations</h3>
        <p><strong>Version:</strong> 1.0.0</p>
        <p><strong>Mode:</strong> Local (SQLite)</p>
        <p><strong>API:</strong> <code x-text="API_BASE"></code></p>
        <hr style="border: 1px solid var(--border); margin: 20px 0;">
        <p style="color: var(--muted);">
          ğŸš€ FonctionnalitÃ©s Ã  venir : thÃ¨mes personnalisÃ©s, authentification,
          synchronisation cloud, notifications push...
        </p>
      </div>
    </section>

  </main>

  <footer>
    <small>ğŸ¥ AutoDesk Kiwi v1.0 - Local Only - Made with â¤ï¸</small>
  </footer>

  
  <script src="app.js"></script>
</body>
</html>