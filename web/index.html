<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AutoDesk Kiwi - Hub personnel de productivitÃ©">
  <title>AutoDesk Kiwi - ProductivitÃ©</title>
  
  <!-- Styles -->
  <link rel="stylesheet" href="style.css">
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="app()" x-init="init()">

  <!-- Toast Container -->
  <div class="toast-container">
    <template x-for="toast in toasts" :key="toast.id">
      <div class="toast" :class="toast.type" x-show="toast.show" x-transition>
        <span class="toast-icon" x-text="toast.icon"></span>
        <span class="toast-message" x-text="toast.message"></span>
        <button class="toast-close" @click="removeToast(toast.id)">Ã—</button>
      </div>
    </template>
  </div>

  <!-- Header -->
  <header class="topbar">
    <h1>ğŸ¥ AutoDesk Kiwi</h1>
    <nav class="tabs">
      <button class="tab" :class="{ active: currentView === 'today' }" @click="currentView = 'today'">
        ğŸ“… Aujourd'hui
      </button>
      <button class="tab" :class="{ active: currentView === 'tasks' }" @click="currentView = 'tasks'">
        âœ… TÃ¢ches
      </button>
      <button class="tab" :class="{ active: currentView === 'weather' }" @click="currentView = 'weather'">
        ğŸŒ¤ï¸ MÃ©tÃ©o
      </button>
      <button class="tab" :class="{ active: currentView === 'hyperplanning' }" @click="currentView = 'hyperplanning'">
        ğŸ“ Hyperplanning
      </button>
      <button class="tab" :class="{ active: currentView === 'settings' }" @click="currentView = 'settings'">
        âš™ï¸ ParamÃ¨tres
      </button>
    </nav>
  </header>

  <main>
    
    <!-- Vue: Today -->
    <section x-show="currentView === 'today'" class="view">
      <h2>ğŸ“… RÃ©sumÃ© du jour</h2>
      
      <div class="card" x-show="overview.quote">
        <p><strong>ğŸ’¬ Citation:</strong> <span x-text="overview.quote"></span></p>
        <p x-show="overview.next_event"><strong>ğŸ“† Prochain Ã©vÃ©nement:</strong> 
          <span x-text="overview.next_event?.title"></span> Ã  
          <span x-text="overview.next_event?.time"></span>
          (<span x-text="overview.next_event?.room"></span>)
        </p>
        <p x-show="weather.current.temp"><strong>ğŸŒ¡ï¸ MÃ©tÃ©o <span x-text="weather.location"></span>:</strong> 
          <span x-text="Math.round(weather.current.temp)"></span>Â°C - 
          <span x-text="getWeatherDesc(weather.current.weathercode)"></span>
        </p>
        <p x-show="overview.unread"><strong>ğŸ“¬ Non lus:</strong> 
          Proton: <span x-text="overview.unread?.proton"></span>, 
          Outlook: <span x-text="overview.unread?.outlook"></span>
        </p>
      </div>

      <h3>ğŸ“Š Statistiques des tÃ¢ches</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" x-text="stats.total || 0"></div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="stats.by_status?.todo || 0"></div>
          <div class="stat-label">Ã€ faire</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="stats.by_status?.doing || 0"></div>
          <div class="stat-label">En cours</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" x-text="stats.by_status?.done || 0"></div>
          <div class="stat-label">TerminÃ©es</div>
        </div>
      </div>
    </section>

    <!-- Vue: Tasks -->
    <section x-show="currentView === 'tasks'" class="view">
      <h2>âœ… Gestion des tÃ¢ches</h2>

      <!-- Add Task Form -->
      <form @submit.prevent="addTask()" class="toolbar">
        <input 
          x-model="newTask.title" 
          type="text" 
          placeholder="Nouvelle tÃ¢cheâ€¦" 
          required 
          maxlength="200"
          class="grow"
        />
        <select x-model="newTask.priority">
          <option value="low">Low</option>
          <option value="normal" selected>Normal</option>
          <option value="high">High</option>
        </select>
        <button type="submit" class="primary">â• Ajouter</button>
      </form>

      <!-- Filters -->
      <div class="toolbar">
        <input 
          x-model="filters.q" 
          @input="debouncedLoadTasks()"
          type="search" 
          placeholder="ğŸ” Rechercherâ€¦"
          class="grow"
        />
        <select x-model="filters.status" @change="loadTasks()">
          <option value="">Tous statuts</option>
          <option value="todo">Ã€ faire</option>
          <option value="doing">En cours</option>
          <option value="done">TerminÃ©es</option>
          <option value="archived">ArchivÃ©es</option>
        </select>
        <select x-model="filters.priority" @change="loadTasks()">
          <option value="">Toutes prioritÃ©s</option>
          <option value="low">Low</option>
          <option value="normal">Normal</option>
          <option value="high">High</option>
        </select>
        <select x-model="filters.sort" @change="loadTasks()">
          <option value="-created_at">Plus rÃ©centes</option>
          <option value="created_at">Plus anciennes</option>
          <option value="-priority">PrioritÃ© â†“</option>
          <option value="priority">PrioritÃ© â†‘</option>
          <option value="title">Titre A-Z</option>
          <option value="-title">Titre Z-A</option>
        </select>
        <button 
          @click="bulkDelete()" 
          class="danger"
          :disabled="selectedTasks.length === 0"
        >
          ğŸ—‘ï¸ Supprimer (<span x-text="selectedTasks.length"></span>)
        </button>
      </div>

      <!-- Tasks List -->
      <ul class="list" x-show="!loading.tasks">
        <template x-if="tasks.length === 0">
          <li class="empty">Aucune tÃ¢che trouvÃ©e.</li>
        </template>
        
        <template x-for="task in tasks" :key="task.id">
          <li class="task-item">
            <input 
              type="checkbox" 
              class="task-select"
              :value="task.id"
              @change="toggleTaskSelection(task.id)"
              :checked="selectedTasks.includes(task.id)"
            />
            <div class="task-main">
              <span class="task-title" x-text="task.title"></span>
              <div class="task-meta">
                <span class="status-badge badge" :class="task.status" x-text="mapStatus(task.status)"></span>
                <span class="badge" :class="task.priority" x-text="task.priority"></span>
              </div>
            </div>
            <button @click="deleteTask(task.id)" class="danger" style="padding: 6px 10px;">
              ğŸ—‘ï¸
            </button>
          </li>
        </template>
      </ul>

      <div x-show="loading.tasks" class="empty">
        <div class="spinner"></div> Chargement...
      </div>
    </section>

    <!-- Vue: Weather -->
    <section x-show="currentView === 'weather'" class="view">
      <h2>ğŸŒ¤ï¸ MÃ©tÃ©o <span x-text="weather.location" style="color: var(--muted);"></span></h2>
      
      <div class="card" x-show="weather.current.temp">
        <p style="font-size: 1.8rem; margin: 0;">
          <strong x-text="Math.round(weather.current.temp)"></strong>Â°C
        </p>
        <p x-text="getWeatherDesc(weather.current.weathercode)" style="margin: 5px 0;"></p>
        <p style="color: var(--muted); font-size: 0.9rem;">
          Vent: <span x-text="Math.round(weather.current.windspeed)"></span> km/h
        </p>
      </div>

      <div x-show="loading.weather" class="card">
        <div class="spinner"></div> Chargement de la mÃ©tÃ©o...
      </div>

      <h3>Prochaines heure</h3>
      <div class="chips">
        <template x-for="h in weather.hourly.slice(0, 12)" :key="h.time">
          <span class="pill" x-text="`${new Date(h.time).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})} â€¢ ${Math.round(h.temp)}Â°C â€¢ ${getWeatherDesc(h.code)} â€¢ ${h.pop || 0}%`"></span>
        </template>
      </div>

      <h3>Prochains jours</h3>
      <div class="chips">
        <template x-for="d in weather.daily" :key="d.date">
          <span class="pill" x-text="`${new Date(d.date).toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric'})} â€¢ ${Math.round(d.tmin)}Â°Câ€“${Math.round(d.tmax)}Â°C â€¢ ${getWeatherDesc(d.code)} â€¢ ${d.pop || 0}%`"></span>
        </template>
      </div>
    </section>

    <!-- Vue: Hyperplanning -->
    <section x-show="currentView === 'hyperplanning'" class="view">
      <h2>ğŸ“ Hyperplanning</h2>
      
      <div class="hp-grid">
        <!-- Colonne Gauche: Emploi du temps -->
        <div class="hp-column">
          <h3 x-text="'ğŸ“… Emploi du temps (' + (hyperplanning.schedule.display_date || 'Aujourd\'hui') + ')'"></h3>
          <div class="card" x-show="hyperplanning.schedule.courses.length === 0">
            <p class="empty">Aucun cours prÃ©vu pour cette date ğŸ‰</p>
          </div>
          <div class="timeline">
            <template x-for="course in hyperplanning.schedule.courses" :key="course.id">
              <div class="timeline-item">
                <div class="timeline-time">
                  <span x-text="course.start"></span>
                  <span class="text-muted" x-text="course.end"></span>
                </div>
                <div class="timeline-content" :class="{'active': isCurrentCourse(course)}">
                  <div class="timeline-marker"></div>
                  <h4 x-text="course.subject"></h4>
                  <p class="location">ğŸ“ <span x-text="course.room"></span></p>
                  <p class="teacher">ğŸ‘¨â€ğŸ« <span x-text="course.teacher"></span></p>
                  <span class="badge" :class="course.type === 'TP' ? 'high' : 'normal'" x-text="course.type"></span>
                </div>
              </div>
            </template>
          </div>

          <!-- Prochains cours -->
          <div class="card" style="margin-top: 20px;">
            <h3>â© Prochains cours</h3>
            <ul class="list">
              <template x-for="course in hyperplanning.nextCourses" :key="course.id">
                <li class="grade-item"> <!-- Reuse grade-item style for list layout -->
                  <div class="grade-info">
                    <strong x-text="course.subject"></strong>
                    <div style="font-size: 0.85rem; color: var(--muted);">
                      <span x-text="new Date(course.raw_start).toLocaleDateString('fr-FR', {weekday: 'short', day: 'numeric', month: 'short'})"></span>
                      â€¢ 
                      <span x-text="course.start + (course.end ? ' - ' + course.end : '')"></span>
                    </div>
                  </div>
                  <div class="grade-value" style="font-size: 0.9rem; color: var(--text);">
                    <span x-text="course.room"></span>
                  </div>
                </li>
              </template>
            </ul>
            <div x-show="hyperplanning.nextCourses.length === 0" class="empty">
              Aucun cours Ã  venir.
            </div>
          </div>
        </div>

        <!-- Colonne Droite: Notes & Infos -->
        <div class="hp-column">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="margin: 0;">ğŸ“ DerniÃ¨res notes</h3>
            <button @click="hyperplanning.showImport = !hyperplanning.showImport" class="btn" style="font-size: 0.85rem; padding: 5px 10px;">
              <span x-show="!hyperplanning.showImport">â• Importer</span>
              <span x-show="hyperplanning.showImport">âœ–ï¸ Fermer</span>
            </button>
          </div>

          <!-- Import Section -->
          <div x-show="hyperplanning.showImport" class="card" style="margin-bottom: 15px; background: var(--panel-hover);">
            <h4 style="margin-top: 0; font-size: 0.9rem;">Importer des notes (JSON)</h4>
            <p style="font-size: 0.8rem; color: var(--muted); margin-bottom: 10px;">
              Format: <code style="background: var(--bg); padding: 2px 5px; border-radius: 3px;">[{"subject": "MatiÃ¨re", "date": "13 dÃ©c.", "value": 15.5}]</code>
            </p>
            <textarea
              x-model="hyperplanning.importInput"
              rows="6"
              placeholder='[
  {"subject": "Admin rÃ©seau", "date": "13 dÃ©c.", "value": 18.39},
  {"subject": "Anglais", "date": "9 dÃ©c.", "value": 14.50}
]'
              style="width: 100%; padding: 10px; background: var(--bg); color: var(--text); border: 1px solid var(--muted); border-radius: 5px; font-family: monospace; font-size: 0.85rem; resize: vertical;"
            ></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
              <button @click="importGrades()" class="primary" style="flex: 1;">âœ… Importer</button>
              <button @click="clearGrades()" class="danger">ğŸ—‘ï¸ Tout supprimer</button>
            </div>
          </div>

          <div class="card">
            <ul class="list">
              <template x-for="grade in hyperplanning.grades" :key="grade.id">
                <li class="grade-item">
                  <div class="grade-info">
                    <strong x-text="grade.subject"></strong>
                    <small x-text="grade.date"></small>
                  </div>
                  <div class="grade-value" :class="getGradeColor(grade.value)">
                    <span x-text="grade.value"></span><span class="grade-max">/20</span>
                  </div>
                </li>
              </template>
            </ul>
            <div x-show="hyperplanning.grades.length === 0" class="empty">
              Aucune note. Cliquez sur "Importer" pour ajouter vos notes.
            </div>
          </div>

          <h3 style="margin-top: 20px;">ğŸ“š Enseignements par matiÃ¨re</h3>
          <div class="card">
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px;">
              <template x-for="stat in hyperplanning.stats" :key="stat.subject">
                <div class="stat-card" style="text-align: center; padding: 10px;">
                  <div class="stat-value" style="font-size: 1.2rem;" x-text="stat.done + 'h'"></div>
                  <div class="stat-label" style="font-size: 0.8rem; margin-bottom: 5px;" x-text="stat.subject"></div>
                  <div style="font-size: 0.7rem; color: var(--muted);">
                    PrÃ©vu: <span x-text="stat.planned"></span>h
                  </div>
                </div>
              </template>
            </div>
            <div x-show="hyperplanning.stats.length === 0" class="empty">
              Chargement des statistiques...
            </div>
          </div>

          <h3 style="margin-top: 20px;">ğŸ”— AccÃ¨s rapide</h3>
          <div class="card">
            <a href="https://extranet-hp-cgy.ensup.eu/hp-cgy/etudiant" target="_blank" class="hp-link">
              ğŸŒ Ouvrir Hyperplanning (Extranet) â†—
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Vue: Settings -->
    <section x-show="currentView === 'settings'" class="view">
      <h2>âš™ï¸ ParamÃ¨tres</h2>
      <div class="card">
        <h3>â„¹ï¸ Informations</h3>
        <p><strong>Version:</strong> 1.0.0</p>
        <p><strong>Mode:</strong> Local (SQLite)</p>
        <p><strong>API:</strong> <code x-text="API_BASE"></code></p>
        <hr style="border: 1px solid var(--border); margin: 20px 0;">
        <p style="color: var(--muted);">
          ğŸš€ FonctionnalitÃ©s Ã  venir : thÃ¨mes personnalisÃ©s, authentification, 
          synchronisation cloud, notifications push...
        </p>
      </div>
    </section>

  </main>

  <footer>
    <small>ğŸ¥ AutoDesk Kiwi v1.0 - Local Only - Made with â¤ï¸</small>
  </footer>

  <!-- Application Logic -->
  <script src="app.js"></script>
</body>
</html>